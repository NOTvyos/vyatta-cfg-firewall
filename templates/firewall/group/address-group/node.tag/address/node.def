multi: 
type: txt
help: Address-group member
val_help: ipv4; IPv4 address to match
val_help: ipv4range; IPv4 range to match (e.g. 10.0.0.1-10.0.0.200)

syntax:expression: exec "sudo /opt/vyatta/sbin/vyatta-ipset.pl \
                           --action=check-member          \
                           --set-name=$VAR(../@)          \
                           --set-type=address             \
                           --member=\"$VAR(@)\"; "

create: tmpgrp=$VAR(../@)-$PPID
        len=${#tmpgrp}
        if [ "$len" -gt 31 ]; then
           tmpgrp=${tmpgrp: -31};
           if [[ "$tmpgrp" =~ ^- ]]; then
              tmpgrp=${tmpgrp/-/Z};
           fi
        fi
        tmpfile="/tmp/$tmpgrp";

        # echo create $VAR(@) $tmpgrp $COMMIT_SIBLING_POSITION

        if [ "$COMMIT_SIBLING_POSITION" = "FIRST" ] || \
           [ "$COMMIT_SIBLING_POSITION" = "FIRSTLAST" ] ; then
           sudo /opt/vyatta/sbin/vyatta-ipset.pl --action=is-set-empty \
             --set-name=$VAR(../@) 
           if [ $? != 0 ]; then
              # echo create $tmpfile;
              touch $tmpfile;
           fi;
           sudo /opt/vyatta/sbin/vyatta-ipset.pl --action=copy-set \
             --set-name=$VAR(../@) --set-type=address --set-copy=$tmpgrp
           # echo create $tmpgrp
        fi;

        sudo /opt/vyatta/sbin/vyatta-ipset.pl --action=add-member \
          --set-name="$tmpgrp" --member="$VAR(@)" --alias=$VAR(../@)
        if [ $? != 0 ]; then
                # echo error adding, destroy $tmpgrp
                sudo ipset --destroy $tmpgrp;
                if [ -e $tmpfile ]; then
                   # echo destroy $VAR(../@)
                   sudo ipset --destroy $VAR(../@);
                   rm $tmpfile;
                fi;
                exit 1;
        fi;

        if [ "$COMMIT_SIBLING_POSITION" = "LAST" ] || \
           [ "$COMMIT_SIBLING_POSITION" = "FIRSTLAST" ] ; then
           # echo swap and destroy $tmpgrp
           sudo ipset --swap $tmpgrp "$VAR(../@)";
           sudo ipset --destroy $tmpgrp;
           rm -f $tmpfile;
        fi;

delete: tmpgrp=$VAR(../@)-$PPID
        len=${#tmpgrp}
        if [ "$len" -gt 31 ]; then
           tmpgrp=${tmpgrp: -31};
           if [[ "$tmpgrp" =~ ^- ]]; then
              tmpgrp=${tmpgrp/-/Z};
           fi
        fi
        tmpfile="/tmp/$tmpgrp";

        # echo delete $VAR(@) $tmpgrp $COMMIT_SIBLING_POSITION

        if [ "$COMMIT_SIBLING_POSITION" = "FIRST" ] || \
           [ "$COMMIT_SIBLING_POSITION" = "FIRSTLAST" ] ; then
           sudo /opt/vyatta/sbin/vyatta-ipset.pl --action=is-set-empty \
             --set-name=$VAR(../@) 
           if [ $? != 0 ]; then
              # echo create $tmpfile;
              touch $tmpfile;
           fi;
           sudo /opt/vyatta/sbin/vyatta-ipset.pl --action=copy-set \
             --set-name=$VAR(../@) --set-type=address --set-copy=$tmpgrp
           # echo create $tmpgrp
        fi;

        sudo /opt/vyatta/sbin/vyatta-ipset.pl --action=is-group-deleted \
                --set-name=$VAR(../@) --set-type=address;
        if [ $? == 0 ] ; then
           sudo /opt/vyatta/sbin/vyatta-ipset.pl --action=is-group-used \
             --set-name=$VAR(../@) --set-type=address
           if [ $? == 0 ] ; then
              echo "Error: group [$VAR(../@)] still in use."
              exit 1;
           fi
        fi

        sudo /opt/vyatta/sbin/vyatta-ipset.pl --action=delete-member \
          --set-name=$tmpgrp \
          --member="$VAR(@)"

        if [ "$COMMIT_SIBLING_POSITION" = "LAST" ] || \
           [ "$COMMIT_SIBLING_POSITION" = "FIRSTLAST" ] ; then
           # echo swap and destroy $tmpgrp
           sudo ipset --swap $tmpgrp "$VAR(../@)";
           sudo ipset --destroy $tmpgrp;
           rm -f $tmpfile;
        fi;
