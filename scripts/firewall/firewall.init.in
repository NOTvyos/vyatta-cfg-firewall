#!/bin/bash
# **** License ****
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License version 2 as
# published by the Free Software Foundation.
#
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# General Public License for more details.
#
# This code was originally developed by Vyatta, Inc.
# Portions created by Vyatta are Copyright (C) 2007 Vyatta, Inc.
# All Rights Reserved.
#
# Author:	Tom Grennan <tgrennan@vyatta.com>
# Description:	firewall init 
#		this is an indirect init sub-script executed by ofr.init
#
# **** End License ****

prefix=@prefix@
exec_prefix=@exec_prefix@
bindir=@bindir@
sbindir=@sbindir@

export PATH=/usr/bin:/usr/sbin:/bin:/sbin:$bindir:$sbindir

. /lib/lsb/init-functions

ACTION=$1

declare -a modules=(
    nf_conntrack
    nf_conntrack_ftp
    nf_conntrack_tftp
    nf_nat
    nf_nat_ftp
    nf_nat_tftp
    nf_nat_proto_gre
    nf_nat_sip
    nf_nat_h323
    nf_nat_pptp)

## setup firewall & nat conntrack modules
start () {
    for mod in ${modules[@]} ; do 
	modprobe --syslog $mod
    done

    # set up notrack chains/rules
    # by default, nothing is tracked.
    iptables -t raw -A PREROUTING -j NOTRACK
    iptables -t raw -A OUTPUT -j NOTRACK
    
    # set up post-firewall hook
    iptables -N VYATTA_POST_FW_HOOK
    iptables -A VYATTA_POST_FW_HOOK -j ACCEPT

    # enforce strict host matching (see bug 4061)
    iptables -P INPUT -j DROP
    iptables -A INPUT -m strict -j VYATTA_POST_FW_HOOK

    iptables -A FORWARD -j VYATTA_POST_FW_HOOK

    # set up pre-SNAT hook
    iptables -t nat -N VYATTA_PRE_SNAT_HOOK
    iptables -t nat -A VYATTA_PRE_SNAT_HOOK -j RETURN
    iptables -t nat -A POSTROUTING -j VYATTA_PRE_SNAT_HOOK
}

case "$ACTION" in
    start) start ;;
    stop|restart|force-reload) true ;; # nothing to stop/restart
    *)	log_failure_msg "action unknown: $ACTION" ;
	false ;;
esac

exit $?

# Local Variables:
# mode: shell-script
# sh-indentation: 4
# End:

